# 安全指南

## 概述

本文档旨在提供项目的安全最佳实践和指南，帮助开发者和运维人员确保系统的安全性。

## 安全措施

### 1. 避免硬编码敏感信息

项目中所有路径和敏感配置都已从代码中移除，改为通过环境变量或配置文件管理：

- Web服务器目录：使用 `WEBSITE_DIR` 环境变量配置
- 日志目录：使用 `LOGS_DIR` 环境变量配置
- 临时文件目录：使用 `TEMP_DIR` 环境变量配置
- PID文件目录：使用 `PID_DIR` 环境变量配置

### 2. 命令执行安全

为了防止命令注入攻击，所有模块都实现了命令安全检查机制：

#### 服务管理器安全检查
- 限制可执行的命令类型
- 禁止危险命令如 `rm -rf`、`format` 等
- 对所有执行的命令进行安全验证

#### 唤醒锁管理器安全检查
- 仅允许预定义的Termux安全命令
- 包括 `termux-wake-lock`、`termux-wake-unlock`、`termux-battery-status`

#### 服务监控器安全检查
- 仅允许PM2相关命令
- 使用正则表达式验证命令格式
- 限制服务名称字符集

### 3. 环境变量安全

使用环境变量管理敏感配置具有以下优势：

1. **避免代码泄露**：敏感信息不会出现在代码中
2. **环境隔离**：不同环境可以使用不同的配置
3. **权限控制**：环境变量可以通过系统权限进行控制

## 安全配置示例

### 设置安全的环境变量

在Linux/Termux环境下：

```bash
# 创建安全的配置目录
mkdir -p $HOME/termux-config
mkdir -p $HOME/termux-logs

# 设置环境变量
export WEBSITE_DIR="$HOME/storage/shared/my-website"
export LOGS_DIR="$HOME/termux-logs"
export TEMP_DIR="$HOME/termux-config/temp"
export PID_DIR="$HOME/termux-config/pids"
```

### 权限设置

确保配置目录具有适当权限：

```bash
# 设置目录权限
chmod 700 $HOME/termux-config
chmod 700 $HOME/termux-logs
```

## 安全审计清单

在部署前，请检查以下项目：

- [ ] 所有路径配置都使用环境变量而非硬编码
- [ ] 没有在代码中存储密码或密钥
- [ ] 命令执行都经过安全验证
- [ ] 敏感目录具有适当权限
- [ ] 环境变量已正确设置
- [ ] 防火墙规则已配置（如适用）

## 常见安全问题及解决方案

### 1. 路径遍历攻击

**问题**：恶意用户可能尝试访问系统其他目录。

**解决方案**：
- 使用环境变量配置路径
- 限制Web服务器可访问的目录
- 实施严格的输入验证

### 2. 命令注入

**问题**：恶意输入可能导致执行意外命令。

**解决方案**：
- 实施命令白名单机制
- 验证所有执行的命令
- 避免直接使用用户输入构造命令

### 3. 权限提升

**问题**：服务可能以过高权限运行。

**解决方案**：
- 使用非特权用户运行服务
- 限制文件和目录访问权限
- 定期审查权限设置

## 监控和日志

安全相关的事件都会通过事件总线发布，可以订阅以下事件进行监控：

- `wakelock.acquire.failed` - 唤醒锁获取失败
- `wakelock.release.failed` - 唤醒锁释放失败
- `service.*.start.failed` - 服务启动失败
- `service.*.stop.failed` - 服务停止失败
- `service.restart.failed` - 服务重启失败

## 定期安全检查

建议定期执行以下安全检查：

1. **代码审查**：检查是否有新引入的硬编码路径或敏感信息
2. **权限审查**：确认文件和目录权限设置是否合理
3. **环境变量检查**：确保环境变量配置正确且安全
4. **依赖更新**：定期更新项目依赖以修复安全漏洞

## 报告安全问题

如果发现任何安全问题，请通过以下方式报告：

1. 创建GitHub Issue（对于非敏感问题）
2. 通过私有渠道联系项目维护者（对于敏感问题）
3. 提供详细的复现步骤和影响说明