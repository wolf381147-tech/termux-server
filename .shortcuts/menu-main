#!/bin/bash

# 主菜单系统
# 集成所有功能模块的统一入口

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 显示主菜单
show_main_menu() {
    clear
    echo "=========================================="
    echo "           🚀 Termux 服务器项目"
    echo "=========================================="
    echo "1. 🖥️  服务器监控面板"
    echo "2. 🔐 SSH 服务管理"
    echo "3. 🌐 Web 服务管理"
    echo "4. 💾 备份工具"
    echo "5. 📊 系统状态"
    echo "6. 🚪 退出"
    echo "=========================================="
}

# SSH服务管理菜单
show_ssh_menu() {
    clear
    echo "=========================================="
    echo "           🔐 SSH 服务管理"
    echo "=========================================="
    echo "1. 🔁 切换SSH服务状态"
    echo "2. ▶️  启动优化SSH服务（防息屏断联）"
    echo "3. 📊 查看SSH状态和连接信息"
    echo "0. ↩️  返回主菜单"
    echo "=========================================="
}

# Web服务管理菜单
show_web_menu() {
    clear
    echo "=========================================="
    echo "           🌐 Web 服务管理"
    echo "=========================================="
    echo "1. 🔁 切换Web服务器状态"
    echo "2. 📊 查看Web状态和连接信息"
    echo "0. ↩️  返回主菜单"
    echo "=========================================="
}

# 备份工具菜单
show_backup_menu() {
    clear
    echo "=========================================="
    echo "           💾 系统状态快照工具"
    echo "=========================================="
    echo "说明: 本工具专注于保存和恢复完整的Termux运行环境，"
    echo "      与Git版本控制协同工作而非替代它。"
    echo ""
    echo "1. 📸 创建系统状态快照"
    echo "2. 📋 列出快照文件"
    echo "3. 🧹 清理旧快照"
    echo "0. ↩️  返回主菜单"
    echo "=========================================="
}

# 处理SSH菜单选项
handle_ssh_menu() {
    while true; do
        show_ssh_menu
        read -p "请选择: " ssh_choice
        
        case $ssh_choice in
            1)
                echo -e "${BLUE}切换SSH服务状态...${NC}"
                ~/.shortcuts/service-ssh toggle
                read -p "按回车键继续..."
                ;;
            2)
                echo -e "${BLUE}启动优化SSH服务...${NC}"
                ~/.shortcuts/service-ssh start --optimized
                echo -e "${GREEN}✅ 优化SSH服务启动完成${NC}"
                read -p "按回车键继续..."
                ;;
            3)
                echo -e "${BLUE}检查SSH服务状态...${NC}"
                ~/.shortcuts/service-ssh status
                echo -e "${BLUE}显示SSH连接信息...${NC}"
                ~/.shortcuts/service-ssh info --with-guide
                read -p "按回车键继续..."
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}无效选择，请重新输入${NC}"
                sleep 1
                ;;
        esac
    done
}

# 处理Web菜单选项
handle_web_menu() {
    while true; do
        show_web_menu
        read -p "请选择: " web_choice
        
        case $web_choice in
            1)
                echo -e "${BLUE}切换Web服务器状态...${NC}"
                ~/.shortcuts/service-web toggle --type server
                read -p "按回车键继续..."
                ;;
            2)
                echo -e "${BLUE}检查Web服务状态...${NC}"
                ~/.shortcuts/service-web status --type server
                echo -e "${BLUE}显示Web连接信息...${NC}"
                ~/.shortcuts/service-web info --with-guide
                read -p "按回车键继续..."
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}无效选择，请重新输入${NC}"
                sleep 1
                ;;
        esac
    done
}

# 处理备份菜单选项
handle_backup_menu() {
    while true; do
        show_backup_menu
        read -p "请选择: " backup_choice
        
        case $backup_choice in
            1)
                echo -e "${BLUE}创建系统状态快照...${NC}"
                ~/.shortcuts/tool-backup snapshot
                echo -e "${GREEN}✅ 系统状态快照创建完成${NC}"
                read -p "按回车键继续..."
                ;;
            2)
                echo -e "${BLUE}列出快照文件...${NC}"
                ~/.shortcuts/tool-backup list
                read -p "按回车键继续..."
                ;;
            3)
                echo -e "${BLUE}清理旧快照...${NC}"
                ~/.shortcuts/tool-backup clean
                echo -e "${GREEN}✅ 快照清理完成${NC}"
                read -p "按回车键继续..."
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}无效选择，请重新输入${NC}"
                sleep 1
                ;;
        esac
    done
}

# 主程序循环
main() {
    while true; do
        show_main_menu
        read -p "请选择: " main_choice
        
        case $main_choice in
            1)
                # 新增的服务器监控面板
                ~/.shortcuts/server-monitor
                ;;
            2)
                handle_ssh_menu
                ;;
            3)
                handle_web_menu
                ;;
            4)
                handle_backup_menu
                ;;
            5)
                echo -e "${YELLOW}显示系统状态...${NC}"
                if command -v neofetch >/dev/null 2>&1; then
                    neofetch
                else
                    echo "系统信息:"
                    uname -a
                    echo "用户: $(whoami)"
                    echo "当前目录: $(pwd)"
                fi
                read -p "按回车键继续..."
                ;;
            6)
                echo -e "${GREEN}感谢使用 Termux 服务器项目！${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}无效选择，请重新输入${NC}"
                sleep 1
                ;;
        esac
    done
}

# 执行主程序
main