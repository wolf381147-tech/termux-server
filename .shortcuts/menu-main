#!/bin/bash

# ä¸»èœå•ç³»ç»Ÿ
# é›†æˆæ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„ç»Ÿä¸€å…¥å£

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºä¸»èœå•
show_main_menu() {
    clear
    echo "=========================================="
    echo "           ğŸš€ Termux æœåŠ¡å™¨é¡¹ç›®"
    echo "=========================================="
    echo "1. ğŸŒ æœåŠ¡ç®¡ç†"
    echo "2. ğŸ’¾ å¤‡ä»½å·¥å…·"
    echo "3. ğŸ“ æ–‡ä»¶ç®¡ç†å™¨"
    echo "4. âš™ï¸  ç³»ç»Ÿé…ç½®"
    echo "5. ğŸ“Š ç³»ç»ŸçŠ¶æ€"
    echo "6. ğŸ› ï¸  ç³»ç»Ÿå·¥å…·"
    echo "7. ğŸ“š å¸®åŠ©æ–‡æ¡£"
    echo "0. ğŸšª é€€å‡º"
    echo "=========================================="
}

# æœåŠ¡ç®¡ç†èœå•
show_service_menu() {
    clear
    echo "=========================================="
    echo "           ğŸŒ æœåŠ¡ç®¡ç†"
    echo "=========================================="
    echo "1. SSH æœåŠ¡ç®¡ç†"
    echo "2. Web æœåŠ¡ç®¡ç†"
    echo "3. æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€"
    echo "4. å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    echo "5. åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "0. è¿”å›ä¸»èœå•"
    echo "=========================================="
}

# SSHæœåŠ¡ç®¡ç†
manage_ssh_service() {
    clear
    echo "=========================================="
    echo "           ğŸ” SSH æœåŠ¡ç®¡ç†"
    echo "=========================================="
    echo "1. å¯åŠ¨SSHæœåŠ¡"
    echo "2. åœæ­¢SSHæœåŠ¡"
    echo "3. æŸ¥çœ‹SSHçŠ¶æ€"
    echo "4. æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"
    echo "0. è¿”å›æœåŠ¡ç®¡ç†"
    echo "=========================================="
    
    read -p "è¯·é€‰æ‹©æ“ä½œ [0-4]: " choice
    
    case $choice in
        1)
            echo "å¯åŠ¨SSHæœåŠ¡..."
            ssh_start
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_ssh_service
            ;;
        2)
            echo "åœæ­¢SSHæœåŠ¡..."
            ssh_stop
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_ssh_service
            ;;
        3)
            echo "æŸ¥çœ‹SSHçŠ¶æ€..."
            ssh_status
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_ssh_service
            ;;
        4)
            echo "æ˜¾ç¤ºè¿æ¥ä¿¡æ¯..."
            ssh_info
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_ssh_service
            ;;
        0)
            show_service_menu
            ;;
        *)
            echo "æ— æ•ˆé€‰æ‹©"
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_ssh_service
            ;;
    esac
}

# WebæœåŠ¡ç®¡ç†
manage_web_service() {
    clear
    echo "=========================================="
    echo "           ğŸŒ Web æœåŠ¡ç®¡ç†"
    echo "=========================================="
    echo "1. å¯åŠ¨WebæœåŠ¡"
    echo "2. åœæ­¢WebæœåŠ¡"
    echo "3. æŸ¥çœ‹WebçŠ¶æ€"
    echo "4. æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"
    echo "0. è¿”å›æœåŠ¡ç®¡ç†"
    echo "=========================================="
    
    read -p "è¯·é€‰æ‹©æ“ä½œ [0-4]: " choice
    
    case $choice in
        1)
            echo "å¯åŠ¨WebæœåŠ¡..."
            web_start
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_web_service
            ;;
        2)
            echo "åœæ­¢WebæœåŠ¡..."
            web_stop
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_web_service
            ;;
        3)
            echo "æŸ¥çœ‹WebçŠ¶æ€..."
            web_status
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_web_service
            ;;
        4)
            echo "æ˜¾ç¤ºè¿æ¥ä¿¡æ¯..."
            web_info
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_web_service
            ;;
        0)
            show_service_menu
            ;;
        *)
            echo "æ— æ•ˆé€‰æ‹©"
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            manage_web_service
            ;;
    esac
}

# SSHæœåŠ¡æ“ä½œå‡½æ•°
ssh_start() {
    # æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
    if pgrep -f "sshd" > /dev/null; then
        echo -e "${YELLOW}SSHæœåŠ¡å·²åœ¨è¿è¡Œ${NC}"
        return
    fi
    
    # å¯åŠ¨SSHæœåŠ¡
    sshd
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SSHæœåŠ¡å¯åŠ¨æˆåŠŸ${NC}"
    else
        echo -e "${RED}SSHæœåŠ¡å¯åŠ¨å¤±è´¥${NC}"
    fi
}

ssh_stop() {
    # åœæ­¢SSHæœåŠ¡
    pkill sshd > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SSHæœåŠ¡å·²åœæ­¢${NC}"
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ°è¿è¡Œä¸­çš„SSHæœåŠ¡${NC}"
    fi
}

ssh_status() {
    if pgrep -f "sshd" > /dev/null; then
        echo -e "${GREEN}SSHæœåŠ¡æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}SSHæœåŠ¡æœªè¿è¡Œ${NC}"
    fi
}

ssh_info() {
    local local_ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    local public_ip=$(curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–")
    
    echo "SSHè¿æ¥ä¿¡æ¯:"
    echo "  ç”¨æˆ·å: $(whoami)"
    echo "  ç«¯å£: 8022"
    echo "  æœ¬åœ°IP: ${local_ip:-æœªè¿æ¥}"
    echo "  å…¬ç½‘IP: ${public_ip}"
    echo ""
    echo "è¿æ¥å‘½ä»¤:"
    echo "  ssh -p 8022 $(whoami)@${local_ip:-localhost}"
}

# WebæœåŠ¡æ“ä½œå‡½æ•°
web_start() {
    local web_dir="/data/data/com.termux/files/home/storage/shared/termux-projects"
    local port=8000
    
    # æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
    if pgrep -f "python.*http.server.*${port}" > /dev/null; then
        echo -e "${YELLOW}WebæœåŠ¡å·²åœ¨è¿è¡Œ${NC}"
        return
    fi
    
    # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
    if [ ! -d "$web_dir" ]; then
        echo -e "${YELLOW}Webç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•${NC}"
        mkdir -p "$web_dir"
    fi
    
    # å¯åŠ¨WebæœåŠ¡
    cd "$web_dir" && python -m http.server $port > /dev/null 2>&1 &
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}WebæœåŠ¡å¯åŠ¨æˆåŠŸ${NC}"
        echo "è®¿é—®åœ°å€: http://localhost:$port"
    else
        echo -e "${RED}WebæœåŠ¡å¯åŠ¨å¤±è´¥${NC}"
    fi
}

web_stop() {
    # åœæ­¢WebæœåŠ¡
    pkill -f "python.*http.server" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}WebæœåŠ¡å·²åœæ­¢${NC}"
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ°è¿è¡Œä¸­çš„WebæœåŠ¡${NC}"
    fi
}

web_status() {
    local port=8000
    if pgrep -f "python.*http.server.*${port}" > /dev/null; then
        echo -e "${GREEN}WebæœåŠ¡æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}WebæœåŠ¡æœªè¿è¡Œ${NC}"
    fi
}

web_info() {
    local local_ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    local public_ip=$(curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–")
    local port=8000
    
    echo "WebæœåŠ¡ä¿¡æ¯:"
    echo "  ç«¯å£: $port"
    echo "  æœ¬åœ°IP: ${local_ip:-æœªè¿æ¥}"
    echo "  å…¬ç½‘IP: ${public_ip}"
    echo ""
    echo "è®¿é—®åœ°å€:"
    echo "  http://${local_ip:-localhost}:$port"
}

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
view_all_services() {
    clear
    echo "=========================================="
    echo "           ğŸ“Š æ‰€æœ‰æœåŠ¡çŠ¶æ€"
    echo "=========================================="
    
    echo "SSHæœåŠ¡:"
    ssh_status
    
    echo ""
    echo "WebæœåŠ¡:"
    web_status
    
    echo ""
    read -p "æŒ‰å›è½¦é”®è¿”å›..."
}

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start_all_services() {
    clear
    echo "=========================================="
    echo "           ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    echo "=========================================="
    
    echo "å¯åŠ¨SSHæœåŠ¡..."
    ssh_start
    
    echo ""
    echo "å¯åŠ¨WebæœåŠ¡..."
    web_start
    
    echo ""
    read -p "æŒ‰å›è½¦é”®è¿”å›..."
}

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop_all_services() {
    clear
    echo "=========================================="
    echo "           ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "=========================================="
    
    echo "åœæ­¢SSHæœåŠ¡..."
    ssh_stop
    
    echo ""
    echo "åœæ­¢WebæœåŠ¡..."
    web_stop
    
    echo ""
    read -p "æŒ‰å›è½¦é”®è¿”å›..."
}

# æœåŠ¡ç®¡ç†ä¸»å¾ªç¯
service_menu_loop() {
    while true; do
        show_service_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ [0-5]: " choice
        
        case $choice in
            1)
                manage_ssh_service
                ;;
            2)
                manage_web_service
                ;;
            3)
                view_all_services
                ;;
            4)
                start_all_services
                ;;
            5)
                stop_all_services
                ;;
            0)
                break
                ;;
            *)
                echo "æ— æ•ˆé€‰æ‹©"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
        esac
    done
}

# ä¸»èœå•å¾ªç¯
main_menu_loop() {
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ [0-7]: " choice
        
        case $choice in
            1)
                service_menu_loop
                ;;
            2)
                echo "å¤‡ä»½å·¥å…·åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨å¤‡ä»½å·¥å…·
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                echo "æ–‡ä»¶ç®¡ç†å™¨åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨æ–‡ä»¶ç®¡ç†å™¨
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                echo "ç³»ç»Ÿé…ç½®åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨ç³»ç»Ÿé…ç½®
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            5)
                echo "ç³»ç»ŸçŠ¶æ€åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨ç³»ç»ŸçŠ¶æ€
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            6)
                echo "ç³»ç»Ÿå·¥å…·åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨ç³»ç»Ÿå·¥å…·
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            7)
                echo "å¸®åŠ©æ–‡æ¡£åŠŸèƒ½..."
                # è¿™é‡Œè°ƒç”¨å¸®åŠ©æ–‡æ¡£
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                echo "é€€å‡ºç¨‹åº"
                exit 0
                ;;
            *)
                echo "æ— æ•ˆé€‰æ‹©"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
        esac
    done
}

# å¯åŠ¨ä¸»èœå•
main_menu_loop