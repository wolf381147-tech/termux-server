#!/bin/bash

# ç»Ÿä¸€å¤‡ä»½å·¥å…·
# æ”¯æŒé¡¹ç›®å¤‡ä»½ã€ç³»ç»Ÿå¤‡ä»½ã€å®Œæ•´å¤‡ä»½ç­‰åŠŸèƒ½

# é»˜è®¤é…ç½®
BACKUP_DIR="$HOME/storage/shared"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: tool-backup [é€‰é¡¹] <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  backup    æ‰§è¡Œå¤‡ä»½"
    echo "  list      åˆ—å‡ºå¤‡ä»½æ–‡ä»¶"
    echo "  restore   ä»å¤‡ä»½æ¢å¤"
    echo "  clean     æ¸…ç†æ—§å¤‡ä»½"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -t, --type TYPE         å¤‡ä»½ç±»å‹ (project|system|full|ultimate)"
    echo "  -n, --name NAME         å¤‡ä»½åç§°"
    echo "  -d, --dir DIRECTORY     å¤‡ä»½ç›®å½•"
    echo "  -k, --keep NUMBER       ä¿ç•™å¤‡ä»½æ•°é‡"
    echo "  -h, --help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  tool-backup backup --type project"
    echo "  tool-backup backup --type ultimate"
    echo "  tool-backup list"
    echo "  tool-backup clean --keep 5"
}

# åˆ›å»ºå¤‡ä»½ç›®å½•
create_backup_dir() {
    local backup_name=$1
    local backup_path="$BACKUP_DIR/$backup_name"
    
    if mkdir -p "$backup_path"; then
        echo "$backup_path"
        return 0
    else
        echo -e "${RED}æ— æ³•åˆ›å»ºå¤‡ä»½ç›®å½•: $backup_path${NC}" >&2
        return 1
    fi
}

# é¡¹ç›®å¤‡ä»½
backup_project() {
    local backup_name=$1
    
    echo -e "${BLUE}å¼€å§‹é¡¹ç›®å¤‡ä»½...${NC}"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local backup_path=$(create_backup_dir "$backup_name")
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“ å¤‡ä»½ç›®å½•: $backup_name${NC}"
    
    # 1. å¤‡ä»½è„šæœ¬æ–‡ä»¶
    echo -e "${YELLOW}ğŸ“œ å¤‡ä»½è„šæœ¬æ–‡ä»¶...${NC}"
    cp -r ~/.shortcuts "$backup_path/" 2>/dev/null
    
    # 2. å¤‡ä»½é…ç½®æ–‡ä»¶
    echo -e "${YELLOW}âš™ï¸  å¤‡ä»½é…ç½®æ–‡ä»¶...${NC}"
    cp ~/.bashrc "$backup_path/" 2>/dev/null
    cp ~/.tmux.conf "$backup_path/" 2>/dev/null
    
    # 3. å¤‡ä»½é¡¹ç›®ç›®å½•
    echo -e "${YELLOW}ğŸ“‚ å¤‡ä»½é¡¹ç›®ç›®å½•...${NC}"
    cp -r ~/termux-projects "$backup_path/" 2>/dev/null
    
    # 4. å¤‡ä»½æ–‡æ¡£
    echo -e "${YELLOW}ğŸ“˜ å¤‡ä»½æ–‡æ¡£...${NC}"
    cp -r ~/docs "$backup_path/" 2>/dev/null
    
    echo -e "${GREEN}âœ… é¡¹ç›®å¤‡ä»½å®Œæˆ${NC}"
}

# ç³»ç»Ÿå¤‡ä»½
backup_system() {
    local backup_name=$1
    
    echo -e "${BLUE}å¼€å§‹ç³»ç»Ÿå¤‡ä»½...${NC}"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local backup_path=$(create_backup_dir "$backup_name")
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“ å¤‡ä»½ç›®å½•: $backup_name${NC}"
    
    # 1. å¤‡ä»½æ‰€æœ‰è„šæœ¬å’Œé…ç½®
    echo -e "${YELLOW}ğŸ“œ å¤‡ä»½è„šæœ¬å’Œé…ç½®...${NC}"
    cp -r ~/.shortcuts "$backup_path/"
    cp ~/.bashrc "$backup_path/"
    cp ~/.tmux.conf "$backup_path/" 2>/dev/null || true
    
    # 2. å¤‡ä»½é¡¹ç›®æ–‡ä»¶
    echo -e "${YELLOW}ğŸ“‚ å¤‡ä»½é¡¹ç›®æ–‡ä»¶...${NC}"
    cp -r ~/termux-projects "$backup_path/" 2>/dev/null || true
    
    # 3. å¤‡ä»½ç³»ç»Ÿä¿¡æ¯
    echo -e "${YELLOW}ğŸ’» å¤‡ä»½ç³»ç»Ÿä¿¡æ¯...${NC}"
    echo "ç³»ç»Ÿå¤‡ä»½æ—¶é—´: $(date)" > "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿç”¨æˆ·: $(whoami)" >> "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿæ¶æ„: $(uname -m)" >> "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿç‰ˆæœ¬: $(uname -r)" >> "$backup_path/system-info.txt"
    
    # 4. å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨
    echo -e "${YELLOW}ğŸ“¦ å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨...${NC}"
    if command -v pkg >/dev/null 2>&1; then
        pkg list-installed > "$backup_path/installed-packages.txt"
    fi
    
    echo -e "${GREEN}âœ… ç³»ç»Ÿå¤‡ä»½å®Œæˆ${NC}"
}

# å®Œæ•´å¤‡ä»½
backup_full() {
    local backup_name=$1
    
    echo -e "${BLUE}å¼€å§‹å®Œæ•´å¤‡ä»½...${NC}"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local backup_path=$(create_backup_dir "$backup_name")
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“ å¤‡ä»½ç›®å½•: $backup_name${NC}"
    
    # 1. å¤‡ä»½ä¸»ç›®å½•
    echo -e "${YELLOW}ğŸ  å¤‡ä»½ä¸»ç›®å½•...${NC}"
    tar -czf "$backup_path/home-backup.tar.gz" -C /data/data/com.termux/files ./home --exclude="home/storage" 2>/dev/null || true
    
    # 2. å¤‡ä»½é…ç½®
    echo -e "${YELLOW}âš™ï¸  å¤‡ä»½ç³»ç»Ÿé…ç½®...${NC}"
    cp -r ~/.shortcuts "$backup_path/"
    cp ~/.bashrc "$backup_path/"
    cp ~/.tmux.conf "$backup_path/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ… å®Œæ•´å¤‡ä»½å®Œæˆ${NC}"
}

# ç»ˆæå¤‡ä»½
backup_ultimate() {
    local backup_name=$1
    
    echo -e "${BLUE}å¼€å§‹ç»ˆæå¤‡ä»½...${NC}"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local backup_path=$(create_backup_dir "$backup_name")
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“ å¤‡ä»½ç›®å½•: $backup_name${NC}"
    
    # 1. å¤‡ä»½æ‰€æœ‰è„šæœ¬å’Œé…ç½®
    echo -e "${YELLOW}ğŸ“œ å¤‡ä»½è„šæœ¬å’Œé…ç½®...${NC}"
    cp -r ~/.shortcuts "$backup_path/"
    cp ~/.bashrc "$backup_path/"
    cp ~/.tmux.conf "$backup_path/" 2>/dev/null || true
    
    # 2. å¤‡ä»½é¡¹ç›®æ–‡ä»¶
    echo -e "${YELLOW}ğŸ“‚ å¤‡ä»½é¡¹ç›®æ–‡ä»¶...${NC}"
    cp -r ~/termux-projects "$backup_path/" 2>/dev/null || true
    
    # 3. å¤‡ä»½æ–‡æ¡£å’Œç¬”è®°
    echo -e "${YELLOW}ğŸ“˜ å¤‡ä»½æ–‡æ¡£...${NC}"
    cp -r ~/docs "$backup_path/" 2>/dev/null || true
    
    # 4. å¤‡ä»½ç³»ç»Ÿä¿¡æ¯
    echo -e "${YELLOW}ğŸ’» å¤‡ä»½ç³»ç»Ÿä¿¡æ¯...${NC}"
    echo "ç»ˆæå¤‡ä»½æ—¶é—´: $(date)" > "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿç”¨æˆ·: $(whoami)" >> "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿæ¶æ„: $(uname -m)" >> "$backup_path/system-info.txt"
    echo "ç³»ç»Ÿç‰ˆæœ¬: $(uname -r)" >> "$backup_path/system-info.txt"
    
    # 5. å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨
    echo -e "${YELLOW}ğŸ“¦ å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨...${NC}"
    if command -v pkg >/dev/null 2>&1; then
        pkg list-installed > "$backup_path/installed-packages.txt"
    fi
    
    # 6. åˆ›å»ºå®Œæ•´ç³»ç»Ÿå¤‡ä»½
    echo -e "${YELLOW}ğŸ’¾ åˆ›å»ºå®Œæ•´ç³»ç»Ÿå¤‡ä»½...${NC}"
    tar -czf "$backup_path/full-system-backup.tar.gz" -C /data/data/com.termux/files ./home ./usr --exclude="home/storage" 2>/dev/null || true
    
    echo -e "${GREEN}âœ… ç»ˆæå¤‡ä»½å®Œæˆ${NC}"
}

# æ‰§è¡Œå¤‡ä»½
do_backup() {
    local backup_type=$1
    local backup_name=$2
    
    # è®¾ç½®é»˜è®¤å¤‡ä»½åç§°
    if [ -z "$backup_name" ]; then
        backup_name="termux-backup-$TIMESTAMP"
        case $backup_type in
            project)
                backup_name="termux-project-backup-$TIMESTAMP"
                ;;
            system)
                backup_name="termux-system-backup-$TIMESTAMP"
                ;;
            full)
                backup_name="termux-full-backup-$TIMESTAMP"
                ;;
            ultimate)
                backup_name="termux-ultimate-backup-$TIMESTAMP"
                ;;
        esac
    fi
    
    case $backup_type in
        project)
            backup_project "$backup_name"
            ;;
        system)
            backup_system "$backup_name"
            ;;
        full)
            backup_full "$backup_name"
            ;;
        ultimate)
            backup_ultimate "$backup_name"
            ;;
        *)
            echo -e "${RED}æœªçŸ¥å¤‡ä»½ç±»å‹: $backup_type${NC}"
            return 1
            ;;
    esac
}

# åˆ—å‡ºå¤‡ä»½æ–‡ä»¶
list_backups() {
    echo -e "${BLUE}å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:${NC}"
    echo "=========================================="
    
    if [ -d "$BACKUP_DIR" ]; then
        ls -la "$BACKUP_DIR" | grep "termux-" | head -20
    else
        echo -e "${YELLOW}å¤‡ä»½ç›®å½•ä¸å­˜åœ¨${NC}"
    fi
}

# æ¸…ç†æ—§å¤‡ä»½
clean_backups() {
    local keep_count=$1
    
    if [ -z "$keep_count" ]; then
        keep_count=5
    fi
    
    echo -e "${BLUE}æ¸…ç†æ—§å¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘ $keep_count ä¸ª...${NC}"
    
    if [ -d "$BACKUP_DIR" ]; then
        cd "$BACKUP_DIR"
        # æ‰¾åˆ°æ‰€æœ‰å¤‡ä»½æ–‡ä»¶ï¼ŒæŒ‰æ—¶é—´æ’åºï¼Œåˆ é™¤è¶…å‡ºä¿ç•™æ•°é‡çš„
        ls -t | grep "termux-" | tail -n +$((keep_count + 1)) | while read -r backup; do
            echo -e "${YELLOW}åˆ é™¤æ—§å¤‡ä»½: $backup${NC}"
            rm -rf "$backup"
        done
        echo -e "${GREEN}âœ… å¤‡ä»½æ¸…ç†å®Œæˆ${NC}"
    else
        echo -e "${YELLOW}å¤‡ä»½ç›®å½•ä¸å­˜åœ¨${NC}"
    fi
}

# ä»å¤‡ä»½æ¢å¤
restore_backup() {
    echo -e "${YELLOW}æ¢å¤åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°${NC}"
    echo -e "${BLUE}è¯·æ‰‹åŠ¨è§£å‹å¤‡ä»½æ–‡ä»¶å¹¶æ¢å¤æ‰€éœ€å†…å®¹${NC}"
}

# ä¸»ç¨‹åºé€»è¾‘
main() {
    local command=""
    local backup_type="project"
    local backup_name=""
    local keep_count=""
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            backup)
                command="backup"
                shift
                ;;
            list)
                command="list"
                shift
                ;;
            restore)
                command="restore"
                shift
                ;;
            clean)
                command="clean"
                shift
                ;;
            -t|--type)
                backup_type="$2"
                shift 2
                ;;
            -n|--name)
                backup_name="$2"
                shift 2
                ;;
            -d|--dir)
                BACKUP_DIR="$2"
                shift 2
                ;;
            -k|--keep)
                keep_count="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # æ‰§è¡Œç›¸åº”å‘½ä»¤
    case $command in
        backup)
            do_backup $backup_type $backup_name
            ;;
        list)
            list_backups
            ;;
        restore)
            restore_backup
            ;;
        clean)
            clean_backups $keep_count
            ;;
        *)
            echo -e "${RED}è¯·æŒ‡å®šæœ‰æ•ˆå‘½ä»¤${NC}"
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"