#!/bin/bash

# ç³»ç»ŸçŠ¶æ€å¿«ç…§å·¥å…·
# ä¸“æ³¨äºä¿å­˜å’Œæ¢å¤å®Œæ•´çš„Termuxè¿è¡Œç¯å¢ƒ

# é»˜è®¤é…ç½®
BACKUP_DIR="$HOME/storage/shared"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: tool-backup [é€‰é¡¹] <å‘½ä»¤>"
    echo ""
    echo "è¯´æ˜: æœ¬å·¥å…·ä¸“æ³¨äºä¿å­˜å’Œæ¢å¤å®Œæ•´çš„Termuxè¿è¡Œç¯å¢ƒï¼Œ"
    echo "      ä¸Gitç‰ˆæœ¬æ§åˆ¶ååŒå·¥ä½œè€Œéæ›¿ä»£å®ƒã€‚"
    echo ""
    echo "å‘½ä»¤:"
    echo "  snapshot  åˆ›å»ºç³»ç»ŸçŠ¶æ€å¿«ç…§"
    echo "  list      åˆ—å‡ºå¿«ç…§æ–‡ä»¶"
    echo "  restore   ä»å¿«ç…§æ¢å¤"
    echo "  clean     æ¸…ç†æ—§å¿«ç…§"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -n, --name NAME         å¿«ç…§åç§°"
    echo "  -d, --dir DIRECTORY     å¿«ç…§ç›®å½•"
    echo "  -k, --keep NUMBER       ä¿ç•™å¿«ç…§æ•°é‡"
    echo "  -h, --help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  tool-backup snapshot"
    echo "  tool-backup list"
    echo "  tool-backup clean --keep 3"
}

# åˆ›å»ºå¿«ç…§ç›®å½•
create_snapshot_dir() {
    local snapshot_name=$1
    local snapshot_path="$BACKUP_DIR/$snapshot_name"
    
    if mkdir -p "$snapshot_path"; then
        echo "$snapshot_path"
        return 0
    else
        echo -e "${RED}æ— æ³•åˆ›å»ºå¿«ç…§ç›®å½•: $snapshot_path${NC}" >&2
        return 1
    fi
}

# åˆ›å»ºç³»ç»ŸçŠ¶æ€å¿«ç…§
create_snapshot() {
    local snapshot_name=$1
    
    # è®¾ç½®é»˜è®¤å¿«ç…§åç§°
    if [ -z "$snapshot_name" ]; then
        snapshot_name="termux-snapshot-$TIMESTAMP"
    fi
    
    echo -e "${BLUE}å¼€å§‹åˆ›å»ºç³»ç»ŸçŠ¶æ€å¿«ç…§...${NC}"
    
    # åˆ›å»ºå¿«ç…§ç›®å½•
    local snapshot_path=$(create_snapshot_dir "$snapshot_name")
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“ å¿«ç…§ç›®å½•: $snapshot_name${NC}"
    
    # 1. å¤‡ä»½é‡è¦é…ç½®å’Œæ•°æ®
    echo -e "${YELLOW}ğŸ“‹ å¤‡ä»½é‡è¦é…ç½®å’Œæ•°æ®...${NC}"
    
    # å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨
    echo -e "${YELLOW}ğŸ“¦ å¤‡ä»½å·²å®‰è£…çš„åŒ…åˆ—è¡¨...${NC}"
    if command -v pkg >/dev/null 2>&1; then
        pkg list-installed > "$snapshot_path/installed-packages.txt"
    fi
    
    # å¤‡ä»½Gitä»“åº“çŠ¶æ€
    echo -e "${YELLOW}ğŸ”„ å¤‡ä»½Gitä»“åº“çŠ¶æ€...${NC}"
    cd "$HOME"
    echo "å½“å‰åˆ†æ”¯: $(git branch --show-current 2>/dev/null || echo 'N/A')" > "$snapshot_path/git-status.txt"
    echo "æœ€åæäº¤: $(git log -1 --oneline 2>/dev/null || echo 'N/A')" >> "$snapshot_path/git-status.txt"
    
    # 2. å¤‡ä»½ç”¨æˆ·æ•°æ®
    echo -e "${YELLOW}ğŸ“‚ å¤‡ä»½ç”¨æˆ·æ•°æ®...${NC}"
    if [ -d "$HOME/storage" ]; then
        # åªå¤‡ä»½å…³é”®ç”¨æˆ·æ•°æ®ï¼Œé¿å…è¿‡å¤§æ–‡ä»¶
        find "$HOME/storage" -type f -name "*.txt" -o -name "*.conf" -o -name "*.json" | head -50 | while read file; do
            # ä¿æŒç›®å½•ç»“æ„
            rel_path="${file#$HOME/}"
            mkdir -p "$(dirname "$snapshot_path/user-data/$rel_path")"
            cp "$file" "$snapshot_path/user-data/$rel_path" 2>/dev/null
        done
    fi
    
    # 3. å¤‡ä»½ç³»ç»Ÿä¿¡æ¯
    echo -e "${YELLOW}ğŸ’» å¤‡ä»½ç³»ç»Ÿä¿¡æ¯...${NC}"
    {
        echo "å¿«ç…§æ—¶é—´: $(date)"
        echo "ç³»ç»Ÿç”¨æˆ·: $(whoami)"
        echo "ç³»ç»Ÿæ¶æ„: $(uname -m)"
        echo "ç³»ç»Ÿç‰ˆæœ¬: $(uname -r)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
    } > "$snapshot_path/system-info.txt"
    
    # 4. åˆ›å»ºæ¢å¤è„šæœ¬
    echo -e "${YELLOW}ğŸ”§ åˆ›å»ºæ¢å¤è„šæœ¬...${NC}"
    cat > "$snapshot_path/restore.sh" << 'EOF'
#!/bin/bash
# Termuxç³»ç»ŸçŠ¶æ€æ¢å¤è„šæœ¬

echo "å¼€å§‹æ¢å¤ç³»ç»ŸçŠ¶æ€..."

# æ¢å¤å·²å®‰è£…çš„åŒ…
if [ -f "installed-packages.txt" ]; then
    echo "æ¢å¤å·²å®‰è£…çš„åŒ…..."
    while read package; do
        pkg install -y "$package" 2>/dev/null
    done < installed-packages.txt
fi

# æ¢å¤ç”¨æˆ·æ•°æ®
if [ -d "user-data" ]; then
    echo "æ¢å¤ç”¨æˆ·æ•°æ®..."
    cp -r user-data/* "$HOME/" 2>/dev/null
fi

echo "ç³»ç»ŸçŠ¶æ€æ¢å¤å®Œæˆ"
EOF
    
    chmod +x "$snapshot_path/restore.sh"
    
    echo -e "${GREEN}âœ… ç³»ç»ŸçŠ¶æ€å¿«ç…§åˆ›å»ºå®Œæˆ${NC}"
    echo -e "${BLUE}å¿«ç…§ä½ç½®: $snapshot_path${NC}"
}

# åˆ—å‡ºå¿«ç…§æ–‡ä»¶
list_snapshots() {
    echo -e "${BLUE}ç³»ç»ŸçŠ¶æ€å¿«ç…§åˆ—è¡¨:${NC}"
    echo "=========================================="
    
    if [ -d "$BACKUP_DIR" ]; then
        ls -la "$BACKUP_DIR" | grep "termux-snapshot-" | head -20
    else
        echo -e "${YELLOW}å¿«ç…§ç›®å½•ä¸å­˜åœ¨${NC}"
    fi
}

# æ¸…ç†æ—§å¿«ç…§
clean_snapshots() {
    local keep_count=$1
    
    if [ -z "$keep_count" ]; then
        keep_count=3
    fi
    
    echo -e "${BLUE}æ¸…ç†æ—§å¿«ç…§ï¼Œä¿ç•™æœ€è¿‘ $keep_count ä¸ª...${NC}"
    
    if [ -d "$BACKUP_DIR" ]; then
        cd "$BACKUP_DIR"
        # æ‰¾åˆ°æ‰€æœ‰å¿«ç…§æ–‡ä»¶ï¼ŒæŒ‰æ—¶é—´æ’åºï¼Œåˆ é™¤è¶…å‡ºä¿ç•™æ•°é‡çš„
        ls -t | grep "termux-snapshot-" | tail -n +$((keep_count + 1)) | while read -r snapshot; do
            echo -e "${YELLOW}åˆ é™¤æ—§å¿«ç…§: $snapshot${NC}"
            rm -rf "$snapshot"
        done
        echo -e "${GREEN}âœ… å¿«ç…§æ¸…ç†å®Œæˆ${NC}"
    else
        echo -e "${YELLOW}å¿«ç…§ç›®å½•ä¸å­˜åœ¨${NC}"
    fi
}

# ä»å¿«ç…§æ¢å¤
restore_snapshot() {
    echo -e "${YELLOW}è¦ä»å¿«ç…§æ¢å¤ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œå¿«ç…§ç›®å½•ä¸­çš„restore.shè„šæœ¬${NC}"
    echo -e "${BLUE}ä¾‹å¦‚: cd /path/to/snapshot && ./restore.sh${NC}"
}

# ä¸»ç¨‹åºé€»è¾‘
main() {
    local command=""
    local snapshot_name=""
    local keep_count=""
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            snapshot)
                command="snapshot"
                shift
                ;;
            list)
                command="list"
                shift
                ;;
            restore)
                command="restore"
                shift
                ;;
            clean)
                command="clean"
                shift
                ;;
            -n|--name)
                snapshot_name="$2"
                shift 2
                ;;
            -d|--dir)
                BACKUP_DIR="$2"
                shift 2
                ;;
            -k|--keep)
                keep_count="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # æ‰§è¡Œç›¸åº”å‘½ä»¤
    case $command in
        snapshot)
            create_snapshot $snapshot_name
            ;;
        list)
            list_snapshots
            ;;
        restore)
            restore_snapshot
            ;;
        clean)
            clean_snapshots $keep_count
            ;;
        *)
            echo -e "${RED}è¯·æŒ‡å®šæœ‰æ•ˆå‘½ä»¤${NC}"
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"