#!/bin/bash

# ç»Ÿä¸€SSHæœåŠ¡ç®¡ç†å™¨
# æ”¯æŒå¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æŸ¥çœ‹ã€é…ç½®ç­‰åŠŸèƒ½

# é»˜è®¤é…ç½®
SSH_PORT=8022
SSH_USER=$(whoami)

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: service-ssh [é€‰é¡¹] <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  start     å¯åŠ¨SSHæœåŠ¡"
    echo "  stop      åœæ­¢SSHæœåŠ¡"
    echo "  status    æŸ¥çœ‹SSHæœåŠ¡çŠ¶æ€"
    echo "  config    é…ç½®SSHæœåŠ¡"
    echo "  info      æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -o, --optimized     å¯ç”¨ä¼˜åŒ–æ¨¡å¼ï¼ˆè·å–å”¤é†’é”ï¼‰"
    echo "  -g, --with-guide    æ˜¾ç¤ºè¿æ¥æŒ‡å—"
    echo "  -s, --smart-mode    å¯ç”¨æ™ºèƒ½æ¨¡å¼"
    echo "  -h, --help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  service-ssh start"
    echo "  service-ssh start --optimized"
    echo "  service-ssh stop"
    echo "  service-ssh info"
}

# è·å–æœ¬åœ°IPåœ°å€
get_local_ip() {
    ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1
}

# è·å–å…¬å…±IPåœ°å€
get_public_ip() {
    curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–å…¬å…±IP"
}

# å¯åŠ¨SSHæœåŠ¡
start_ssh() {
    local optimized=$1
    local smart_mode=$2
    
    echo -e "${BLUE}å¯åŠ¨SSHæœåŠ¡...${NC}"
    
    # å¦‚æœå¯ç”¨ä¼˜åŒ–æ¨¡å¼ï¼Œè·å–å”¤é†’é”
    if [ "$optimized" = "true" ] || [ "$smart_mode" = "true" ]; then
        echo -e "${YELLOW}è·å–å”¤é†’é”é˜²æ­¢æ¯å±æ–­è”...${NC}"
        termux-wake-lock
    fi
    
    # å¯åŠ¨SSHæœåŠ¡
    sshd
    
    # å¦‚æœå¯ç”¨æ™ºèƒ½æ¨¡å¼ï¼Œä¿æŒè¿è¡Œ
    if [ "$smart_mode" = "true" ]; then
        echo -e "${GREEN}SSHæœåŠ¡å·²å¯åŠ¨ï¼ˆæ™ºèƒ½æ¨¡å¼ï¼‰${NC}"
        echo "æŒ‰ Ctrl+C åœæ­¢æœåŠ¡"
        trap "stop_ssh; exit 0" INT
        while true; do
            sleep 60
        done
    else
        echo -e "${GREEN}SSHæœåŠ¡å·²å¯åŠ¨${NC}"
    fi
}

# åœæ­¢SSHæœåŠ¡
stop_ssh() {
    echo -e "${BLUE}åœæ­¢SSHæœåŠ¡...${NC}"
    pkill sshd 2>/dev/null
    termux-wake-unlock 2>/dev/null
    echo -e "${GREEN}SSHæœåŠ¡å·²åœæ­¢${NC}"
}

# æŸ¥çœ‹SSHæœåŠ¡çŠ¶æ€
status_ssh() {
    if pgrep sshd > /dev/null; then
        echo -e "${GREEN}SSHæœåŠ¡æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}SSHæœåŠ¡æœªè¿è¡Œ${NC}"
    fi
}

# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
show_info() {
    local with_guide=$1
    
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    if [ -z "$local_ip" ]; then
        local_ip="æ— æ³•è·å–æœ¬åœ°IPï¼Œè¯·æ£€æŸ¥WiFiè¿æ¥"
    fi
    
    echo "=========================================="
    echo "           ğŸ” SSHè¿æ¥ä¿¡æ¯"
    echo "=========================================="
    echo "ğŸ“± æœ¬åœ°IP: $local_ip"
    echo "ğŸŒ å…¬å…±IP: $public_ip"
    echo "ğŸ”Œ ç«¯å£: $SSH_PORT"
    echo "ğŸ‘¤ ç”¨æˆ·å: $SSH_USER"
    echo "=========================================="
    echo "ğŸ’» ä»ç”µè„‘è¿æ¥:"
    echo "   ssh $SSH_USER@$local_ip -p $SSH_PORT"
    echo "=========================================="
    
    if [ "$with_guide" = "true" ]; then
        echo ""
        echo "ğŸ’¡ è¿æ¥æŒ‡å—:"
        echo "   1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œ"
        echo "   2. åœ¨ç”µè„‘ä¸Šæ‰“å¼€ç»ˆç«¯æˆ–SSHå®¢æˆ·ç«¯"
        echo "   3. è¾“å…¥ä¸Šè¿°SSHå‘½ä»¤"
        echo "   4. é¦–æ¬¡è¿æ¥å¯èƒ½éœ€è¦ç¡®è®¤ä¸»æœºå¯†é’¥"
        echo "   5. è¾“å…¥Termuxå¯†ç è¿›è¡Œèº«ä»½éªŒè¯"
    fi
}

# ä¸»ç¨‹åºé€»è¾‘
main() {
    local command=""
    local optimized=false
    local with_guide=false
    local smart_mode=false
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            start)
                command="start"
                shift
                ;;
            stop)
                command="stop"
                shift
                ;;
            status)
                command="status"
                shift
                ;;
            info)
                command="info"
                shift
                ;;
            config)
                command="config"
                shift
                ;;
            -o|--optimized)
                optimized=true
                shift
                ;;
            -g|--with-guide)
                with_guide=true
                shift
                ;;
            -s|--smart-mode)
                smart_mode=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # æ‰§è¡Œç›¸åº”å‘½ä»¤
    case $command in
        start)
            start_ssh $optimized $smart_mode
            if [ "$smart_mode" != "true" ]; then
                show_info $with_guide
            fi
            ;;
        stop)
            stop_ssh
            ;;
        status)
            status_ssh
            ;;
        info)
            show_info $with_guide
            ;;
        config)
            echo "é…ç½®åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
            ;;
        *)
            echo -e "${RED}è¯·æŒ‡å®šæœ‰æ•ˆå‘½ä»¤${NC}"
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"