#!/bin/bash

# SSH服务管理器
# 提供基础的SSH服务管理功能

# 默认配置
SSH_PORT=8022
SSH_USER=$(whoami)

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 显示帮助信息
show_help() {
    echo "用法: service-ssh [选项] <命令>"
    echo ""
    echo "命令:"
    echo "  start     启动SSH服务"
    echo "  stop      停止SSH服务"
    echo "  status    查看SSH服务状态"
    echo "  info      显示连接信息"
    echo ""
    echo "选项:"
    echo "  -h, --help          显示此帮助信息"
    echo ""
    echo "示例:"
    echo "  service-ssh start"
    echo "  service-ssh stop"
    echo "  service-ssh info"
}

# 获取本地IP地址
get_local_ip() {
    ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1
}

# 获取公共IP地址
get_public_ip() {
    curl -s https://api.ipify.org 2>/dev/null || echo "无法获取公共IP"
}

# 启动SSH服务
start_ssh() {
    # 检查是否已运行
    if pgrep -f "sshd" > /dev/null; then
        echo -e "${YELLOW}SSH服务已在运行${NC}"
        return 1
    fi
    
    # 启动SSH服务
    sshd
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SSH服务启动成功${NC}"
        return 0
    else
        echo -e "${RED}SSH服务启动失败${NC}"
        return 1
    fi
}

# 停止SSH服务
stop_ssh() {
    # 停止SSH服务
    pkill sshd > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SSH服务已停止${NC}"
        return 0
    else
        echo -e "${YELLOW}未找到运行中的SSH服务${NC}"
        return 1
    fi
}

# 查看SSH状态
status_ssh() {
    if pgrep -f "sshd" > /dev/null; then
        echo -e "${GREEN}SSH服务正在运行${NC}"
        return 0
    else
        echo -e "${RED}SSH服务未运行${NC}"
        return 1
    fi
}

# 显示连接信息
show_info() {
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    echo "SSH连接信息:"
    echo "  用户名: $SSH_USER"
    echo "  端口: $SSH_PORT"
    echo "  本地IP: ${local_ip:-未连接}"
    echo "  公网IP: ${public_ip}"
    echo ""
    echo "连接命令:"
    echo "  ssh -p $SSH_PORT $SSH_USER@${local_ip:-localhost}"
}

# 主程序入口
main() {
    # 解析命令行参数
    case "$1" in
        start)
            start_ssh
            ;;
        stop)
            stop_ssh
            ;;
        status)
            status_ssh
            ;;
        info)
            show_info
            ;;
        -h|--help)
            show_help
            ;;
        *)
            # 如果没有参数，显示帮助信息
            show_help
            ;;
    esac
}

# 执行主程序
main "$@"