#!/bin/bash

# æ•´åˆæœåŠ¡ç®¡ç†èœå•
# å°†SSHå’ŒWebæœåŠ¡çš„å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æŸ¥çœ‹ã€è¿æ¥ä¿¡æ¯ç­‰åŠŸèƒ½æ•´åˆåœ¨ä¸€èµ·

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºæ•´åˆæœåŠ¡ç®¡ç†èœå•
show_services_menu() {
    clear
    echo "=========================================="
    echo "           ğŸš€ æœåŠ¡ç®¡ç†é¢æ¿"
    echo "=========================================="
    echo "SSH æœåŠ¡:"
    echo "  1. â–¶ï¸  å¯åŠ¨SSHæœåŠ¡"
    echo "  2. â¹ï¸  åœæ­¢SSHæœåŠ¡"
    echo "  3. ğŸ“Š æŸ¥çœ‹SSHçŠ¶æ€"
    echo "  4. â„¹ï¸  SSHè¿æ¥ä¿¡æ¯"
    echo ""
    echo "Web æœåŠ¡:"
    echo "  5. â–¶ï¸  å¯åŠ¨WebæœåŠ¡å™¨"
    echo "  6. â¹ï¸  åœæ­¢WebæœåŠ¡å™¨"
    echo "  7. ğŸ“Š æŸ¥çœ‹WebçŠ¶æ€"
    echo "  8. â„¹ï¸  Webè¿æ¥ä¿¡æ¯"
    echo ""
    echo "å…¶ä»–æ“ä½œ:"
    echo "  9. ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  10. ğŸ“Š æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€"
    echo "  0. â†©ï¸  è¿”å›ä¸»èœå•"
    echo "=========================================="
}

# æ˜¾ç¤ºSSHè¿æ¥ä¿¡æ¯
show_ssh_info() {
    echo "=========================================="
    echo "           ğŸ” SSHè¿æ¥ä¿¡æ¯"
    echo "=========================================="
    
    # è·å–SSHæœåŠ¡çŠ¶æ€
    if pgrep sshd > /dev/null; then
        echo -e "${GREEN}âœ… SSHæœåŠ¡æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}âŒ SSHæœåŠ¡æœªè¿è¡Œ${NC}"
    fi
    
    # è·å–IPåœ°å€ä¿¡æ¯
    local local_ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$local_ip" ]; then
        local_ip="æ— æ³•è·å–æœ¬åœ°IPï¼Œè¯·æ£€æŸ¥WiFiè¿æ¥"
    fi
    
    local public_ip=$(curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–å…¬å…±IP")
    
    echo "ğŸ“± æœ¬åœ°IP: $local_ip"
    echo "ğŸŒ å…¬å…±IP: $public_ip"
    echo "ğŸ”Œ ç«¯å£: 8022"
    echo "ğŸ‘¤ ç”¨æˆ·å: $(whoami)"
    echo "=========================================="
    echo "ğŸ’» ä»ç”µè„‘è¿æ¥:"
    echo "   ssh $(whoami)@$local_ip -p 8022"
    echo "=========================================="
}

# æ˜¾ç¤ºWebè¿æ¥ä¿¡æ¯
show_web_info() {
    echo "=========================================="
    echo "           ğŸŒ Webè¿æ¥ä¿¡æ¯"
    echo "=========================================="
    
    # è·å–WebæœåŠ¡çŠ¶æ€
    if pgrep -f "http.server" > /dev/null; then
        echo -e "${GREEN}âœ… WebæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}âŒ WebæœåŠ¡å™¨æœªè¿è¡Œ${NC}"
    fi
    
    # è·å–IPåœ°å€ä¿¡æ¯
    local local_ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$local_ip" ]; then
        local_ip="æ— æ³•è·å–æœ¬åœ°IPï¼Œè¯·æ£€æŸ¥WiFiè¿æ¥"
    fi
    
    local public_ip=$(curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–å…¬å…±IP")
    
    echo "ğŸ“± æœ¬åœ°IP: $local_ip"
    echo "ğŸŒ å…¬å…±IP: $public_ip"
    echo "ğŸ”Œ ç«¯å£: 8000"
    echo "ğŸ“‚ ç›®å½•: ~/storage/shared/termux-projects"
    echo "=========================================="
    echo "ğŸ’» è®¿é—®åœ°å€:"
    echo "   http://$local_ip:8000"
    echo "=========================================="
}

# æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡çŠ¶æ€
show_all_status() {
    echo "=========================================="
    echo "           ğŸ“Š æœåŠ¡çŠ¶æ€æ€»è§ˆ"
    echo "=========================================="
    
    # SSHæœåŠ¡çŠ¶æ€
    echo -n "ğŸ” SSHæœåŠ¡: "
    if pgrep sshd > /dev/null; then
        echo -e "${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}å·²åœæ­¢${NC}"
    fi
    
    # WebæœåŠ¡å™¨çŠ¶æ€
    echo -n "ğŸŒ WebæœåŠ¡å™¨: "
    if pgrep -f "http.server" > /dev/null; then
        echo -e "${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}å·²åœæ­¢${NC}"
    fi
    
    # Webæ–‡ä»¶ç®¡ç†å™¨çŠ¶æ€
    echo -n "ğŸ“ Webæ–‡ä»¶ç®¡ç†å™¨: "
    if pgrep -f "web-file-manager.py" > /dev/null; then
        echo -e "${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}å·²åœæ­¢${NC}"
    fi
    
    # Web GUIçŠ¶æ€
    echo -n "ğŸ–¥ï¸  Web GUI: "
    if pgrep -f "web-gui/app.py" > /dev/null; then
        echo -e "${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}å·²åœæ­¢${NC}"
    fi
    
    echo "=========================================="
}

# é‡å¯æ‰€æœ‰æœåŠ¡
restart_all_services() {
    echo -e "${BLUE}ğŸ”„ æ­£åœ¨é‡å¯æ‰€æœ‰æœåŠ¡...${NC}"
    
    # åœæ­¢æ‰€æœ‰æœåŠ¡
    echo -e "${YELLOW}â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    ~/.shortcuts/service-ssh stop > /dev/null 2>&1
    ~/.shortcuts/service-web stop --type server > /dev/null 2>&1
    ~/.shortcuts/service-web stop --type manager > /dev/null 2>&1
    ~/.shortcuts/service-web stop --type gui > /dev/null 2>&1
    sleep 2
    
    # å¯åŠ¨æ ¸å¿ƒæœåŠ¡
    echo -e "${YELLOW}â–¶ï¸  å¯åŠ¨æ ¸å¿ƒæœåŠ¡...${NC}"
    ~/.shortcuts/service-ssh start --optimized > /dev/null 2>&1
    ~/.shortcuts/service-web start --type server > /dev/null 2>&1
    ~/.shortcuts/service-web start --type manager --background > /dev/null 2>&1
    sleep 2
    
    echo -e "${GREEN}âœ… æ‰€æœ‰æœåŠ¡å·²é‡å¯${NC}"
}

# ä¸»å¾ªç¯
main() {
    while true; do
        show_services_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ: " choice
        
        case $choice in
            1)
                echo -e "${BLUE}â–¶ï¸  æ­£åœ¨å¯åŠ¨SSHæœåŠ¡...${NC}"
                ~/.shortcuts/service-ssh start --optimized
                echo -e "${GREEN}âœ… SSHæœåŠ¡å¯åŠ¨å®Œæˆ${NC}"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                echo -e "${BLUE}â¹ï¸  æ­£åœ¨åœæ­¢SSHæœåŠ¡...${NC}"
                ~/.shortcuts/service-ssh stop
                echo -e "${GREEN}âœ… SSHæœåŠ¡å·²åœæ­¢${NC}"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                echo -e "${BLUE}ğŸ“Š æ£€æŸ¥SSHæœåŠ¡çŠ¶æ€...${NC}"
                ~/.shortcuts/service-ssh status
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                show_ssh_info
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            5)
                echo -e "${BLUE}â–¶ï¸  æ­£åœ¨å¯åŠ¨WebæœåŠ¡å™¨...${NC}"
                ~/.shortcuts/service-web start --type server
                echo -e "${GREEN}âœ… WebæœåŠ¡å™¨å¯åŠ¨å®Œæˆ${NC}"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            6)
                echo -e "${BLUE}â¹ï¸  æ­£åœ¨åœæ­¢WebæœåŠ¡å™¨...${NC}"
                ~/.shortcuts/service-web stop --type server
                echo -e "${GREEN}âœ… WebæœåŠ¡å™¨å·²åœæ­¢${NC}"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            7)
                echo -e "${BLUE}ğŸ“Š æ£€æŸ¥WebæœåŠ¡çŠ¶æ€...${NC}"
                ~/.shortcuts/service-web status --type server
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            8)
                show_web_info
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            9)
                restart_all_services
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            10)
                show_all_status
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                echo -e "${GREEN}â†©ï¸  è¿”å›ä¸»èœå•${NC}"
                return
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥${NC}"
                sleep 1
                ;;
        esac
    done
}

# æ‰§è¡Œä¸»ç¨‹åº
main