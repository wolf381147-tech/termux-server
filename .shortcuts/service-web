#!/bin/bash

# Web服务管理器
# 提供基础的Web服务管理功能

# 默认配置
WEB_PORT=8000
WEB_DIR="/data/data/com.termux/files/home/storage/shared/termux-projects"
WEB_USER=$(whoami)

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 显示帮助信息
show_help() {
    echo "用法: service-web [选项] <命令>"
    echo ""
    echo "命令:"
    echo "  start     启动Web服务"
    echo "  stop      停止Web服务"
    echo "  status    查看Web服务状态"
    echo "  info      显示连接信息"
    echo ""
    echo "选项:"
    echo "  -h, --help              显示此帮助信息"
    echo ""
    echo "示例:"
    echo "  service-web start"
    echo "  service-web stop"
    echo "  service-web info"
}

# 获取本地IP地址
get_local_ip() {
    ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1
}

# 获取公共IP地址
get_public_ip() {
    curl -s https://api.ipify.org 2>/dev/null || echo "无法获取公共IP"
}

# 启动Web服务
start_web() {
    # 检查是否已运行
    if pgrep -f "python.*http.server.*${WEB_PORT}" > /dev/null; then
        echo -e "${YELLOW}Web服务已在运行${NC}"
        return 1
    fi
    
    # 检查目录是否存在
    if [ ! -d "$WEB_DIR" ]; then
        echo -e "${YELLOW}Web目录不存在，创建目录${NC}"
        mkdir -p "$WEB_DIR"
    fi
    
    # 启动Web服务
    cd "$WEB_DIR" && python -m http.server $WEB_PORT > /dev/null 2>&1 &
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Web服务启动成功${NC}"
        echo "访问地址: http://localhost:$WEB_PORT"
        return 0
    else
        echo -e "${RED}Web服务启动失败${NC}"
        return 1
    fi
}

# 停止Web服务
stop_web() {
    # 停止Web服务
    pkill -f "python.*http.server" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Web服务已停止${NC}"
        return 0
    else
        echo -e "${YELLOW}未找到运行中的Web服务${NC}"
        return 1
    fi
}

# 查看Web状态
status_web() {
    if pgrep -f "python.*http.server.*${WEB_PORT}" > /dev/null; then
        echo -e "${GREEN}Web服务正在运行${NC}"
        return 0
    else
        echo -e "${RED}Web服务未运行${NC}"
        return 1
    fi
}

# 显示连接信息
show_info() {
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    echo "Web服务信息:"
    echo "  端口: $WEB_PORT"
    echo "  本地IP: ${local_ip:-未连接}"
    echo "  公网IP: ${public_ip}"
    echo ""
    echo "访问地址:"
    echo "  http://${local_ip:-localhost}:$WEB_PORT"
}

# 主程序入口
main() {
    # 解析命令行参数
    case "$1" in
        start)
            start_web
            ;;
        stop)
            stop_web
            ;;
        status)
            status_web
            ;;
        info)
            show_info
            ;;
        -h|--help)
            show_help
            ;;
        *)
            # 如果没有参数，显示帮助信息
            show_help
            ;;
    esac
}

# 执行主程序
main "$@"