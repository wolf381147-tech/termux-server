#!/bin/bash

# ç»Ÿä¸€WebæœåŠ¡ç®¡ç†å™¨
# æ”¯æŒWebæœåŠ¡å™¨ã€æ–‡ä»¶ç®¡ç†å™¨ã€Web GUIç­‰åŠŸèƒ½

# é»˜è®¤é…ç½®
WEB_PORT=8000
WEB_DIR="/data/data/com.termux/files/home/storage/shared/termux-projects"
WEB_USER=$(whoami)

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: service-web [é€‰é¡¹] <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  start     å¯åŠ¨WebæœåŠ¡"
    echo "  stop      åœæ­¢WebæœåŠ¡"
    echo "  toggle    åˆ‡æ¢WebæœåŠ¡çŠ¶æ€"
    echo "  status    æŸ¥çœ‹WebæœåŠ¡çŠ¶æ€"
    echo "  info      æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -t, --type TYPE         æœåŠ¡ç±»å‹ (server|manager|gui)"
    echo "  -d, --dir DIRECTORY     Webç›®å½•"
    echo "  -p, --port PORT         ç«¯å£å·"
    echo "  -b, --background        åå°è¿è¡Œ"
    echo "  -g, --with-guide        æ˜¾ç¤ºä½¿ç”¨æŒ‡å—"
    echo "  -h, --help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  service-web start --type server"
    echo "  service-web start --type manager --background"
    echo "  service-web stop --type server"
    echo "  service-web toggle --type server"
    echo "  service-web info"
}

# è·å–æœ¬åœ°IPåœ°å€
get_local_ip() {
    local ip=""
    
    # æ–¹æ³•1: ä½¿ç”¨ipå‘½ä»¤ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if command -v ip >/dev/null 2>&1; then
        ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    fi
    
    # æ–¹æ³•2: ä½¿ç”¨ifconfigå‘½ä»¤ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if [ -z "$ip" ] && command -v ifconfig >/dev/null 2>&1; then
        ip=$(ifconfig wlan0 2>/dev/null | grep -E "inet[^6]" | awk '{print $2}')
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨netcfgå‘½ä»¤ï¼ˆAndroidç‰¹å®šï¼‰
    if [ -z "$ip" ] && command -v netcfg >/dev/null 2>&1; then
        ip=$(netcfg 2>/dev/null | grep wlan0 | grep -E "UP|RUNNING" | awk '{print $3}' | cut -d'/' -f1)
    fi
    
    # æ–¹æ³•4: ä½¿ç”¨ip routeå‘½ä»¤è·å–é»˜è®¤è·¯ç”±æ¥å£IP
    if [ -z "$ip" ] && command -v ip >/dev/null 2>&1; then
        ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1); exit}')
    fi
    
    # æ–¹æ³•5: ä½¿ç”¨hostnameå‘½ä»¤
    if [ -z "$ip" ] && command -v hostname >/dev/null 2>&1; then
        ip=$(hostname -I 2>/dev/null | awk '{print $1}')
    fi
    
    # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•è¯»å–ç³»ç»Ÿæ–‡ä»¶
    if [ -z "$ip" ]; then
        # å°è¯•è¯»å–ç³»ç»Ÿç½‘ç»œæ¥å£ä¿¡æ¯
        if [ -f "/sys/class/net/wlan0/operstate" ] && [ "$(cat /sys/class/net/wlan0/operstate 2>/dev/null)" = "up" ]; then
            if [ -f "/sys/class/net/wlan0/address" ]; then
                ip=$(cat /sys/class/net/wlan0/address 2>/dev/null)
            fi
        fi
    fi
    
    echo "$ip"
}

# è·å–å…¬å…±IPåœ°å€
get_public_ip() {
    curl -s https://api.ipify.org 2>/dev/null || echo "æ— æ³•è·å–å…¬å…±IP"
}

# å¯åŠ¨WebæœåŠ¡
start_web() {
    local service_type=$1
    local background=$2
    local port=$3
    local directory=$4
    
    # è®¾ç½®é»˜è®¤å€¼
    if [ -z "$port" ]; then
        port=$WEB_PORT
    fi
    
    if [ -z "$directory" ]; then
        directory=$WEB_DIR
    fi
    
    echo -e "${BLUE}å¯åŠ¨WebæœåŠ¡ ($service_type)...${NC}"
    
    case $service_type in
        server)
            # å¯åŠ¨Python WebæœåŠ¡å™¨
            if [ "$background" = "true" ]; then
                cd "$directory" && python -m http.server $port > /dev/null 2>&1 &
                echo -e "${GREEN}WebæœåŠ¡å™¨å·²åœ¨åå°å¯åŠ¨${NC}"
            else
                echo -e "${YELLOW}åœ¨ç›®å½• $directory å¯åŠ¨WebæœåŠ¡å™¨ï¼Œç«¯å£ $port${NC}"
                cd "$directory" && python -m http.server $port
            fi
            ;;
        manager)
            # å¯åŠ¨Webæ–‡ä»¶ç®¡ç†å™¨
            if [ "$background" = "true" ]; then
                # æ€æ­»å¯èƒ½å­˜åœ¨çš„æ—§è¿›ç¨‹
                pkill -f "web-file-manager.py" 2>/dev/null
                
                # å¯åŠ¨Webæ–‡ä»¶ç®¡ç†å™¨ï¼Œå¹¶ä¿æŒè¿è¡Œ
                while true; do
                    python /data/data/com.termux/files/home/web-file-manager.py > /dev/null 2>&1 &
                    echo -e "${GREEN}Webæ–‡ä»¶ç®¡ç†å™¨å·²åœ¨åå°å¯åŠ¨${NC}"
                    break
                done
            else
                python /data/data/com.termux/files/home/web-file-manager.py
            fi
            ;;
        gui)
            # å¯åŠ¨Web GUI
            echo -e "${YELLOW}å¯åŠ¨Web GUI...${NC}"
            python /data/data/com.termux/files/home/web-gui/app.py
            ;;
        *)
            echo -e "${RED}æœªçŸ¥æœåŠ¡ç±»å‹: $service_type${NC}"
            return 1
            ;;
    esac
}

# åœæ­¢WebæœåŠ¡
stop_web() {
    local service_type=$1
    
    echo -e "${BLUE}åœæ­¢WebæœåŠ¡ ($service_type)...${NC}"
    
    case $service_type in
        server)
            pkill -f "http.server" 2>/dev/null
            echo -e "${GREEN}WebæœåŠ¡å™¨å·²åœæ­¢${NC}"
            ;;
        manager)
            pkill -f "web-file-manager.py" 2>/dev/null
            echo -e "${GREEN}Webæ–‡ä»¶ç®¡ç†å™¨å·²åœæ­¢${NC}"
            ;;
        gui)
            pkill -f "web-gui/app.py" 2>/dev/null
            echo -e "${GREEN}Web GUIå·²åœæ­¢${NC}"
            ;;
        *)
            echo -e "${RED}æœªçŸ¥æœåŠ¡ç±»å‹: $service_type${NC}"
            return 1
            ;;
    esac
}

# æŸ¥çœ‹WebæœåŠ¡çŠ¶æ€
status_web() {
    local service_type=$1
    
    case $service_type in
        server)
            if pgrep -f "http.server" > /dev/null; then
                echo -e "${GREEN}WebæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ${NC}"
            else
                echo -e "${RED}WebæœåŠ¡å™¨æœªè¿è¡Œ${NC}"
            fi
            ;;
        manager)
            if pgrep -f "web-file-manager.py" > /dev/null; then
                echo -e "${GREEN}Webæ–‡ä»¶ç®¡ç†å™¨æ­£åœ¨è¿è¡Œ${NC}"
            else
                echo -e "${RED}Webæ–‡ä»¶ç®¡ç†å™¨æœªè¿è¡Œ${NC}"
            fi
            ;;
        gui)
            if pgrep -f "web-gui/app.py" > /dev/null; then
                echo -e "${GREEN}Web GUIæ­£åœ¨è¿è¡Œ${NC}"
            else
                echo -e "${RED}Web GUIæœªè¿è¡Œ${NC}"
            fi
            ;;
        *)
            echo -e "${RED}æœªçŸ¥æœåŠ¡ç±»å‹: $service_type${NC}"
            return 1
            ;;
    esac
}

# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
show_info() {
    local with_guide=$1
    local port=$2
    
    # è®¾ç½®é»˜è®¤ç«¯å£
    if [ -z "$port" ]; then
        port=$WEB_PORT
    fi
    
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    if [ -z "$local_ip" ]; then
        local_ip="æ— æ³•è·å–æœ¬åœ°IPï¼Œè¯·æ£€æŸ¥WiFiè¿æ¥"
    fi
    
    echo "=========================================="
    echo "           ğŸŒ WebæœåŠ¡è¿æ¥ä¿¡æ¯"
    echo "=========================================="
    echo "ğŸ“± æœ¬åœ°IP: $local_ip"
    echo "ğŸŒ å…¬å…±IP: $public_ip"
    echo "ğŸ”Œ ç«¯å£: $port"
    echo "ğŸ“‚ ç›®å½•: $WEB_DIR"
    echo "=========================================="
    echo "ğŸ’» è®¿é—®åœ°å€:"
    echo "   http://$local_ip:$port"
    echo "=========================================="
    
    if [ "$with_guide" = "true" ]; then
        echo ""
        echo "ğŸ’¡ ä½¿ç”¨æŒ‡å—:"
        echo "   1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œ"
        echo "   2. åœ¨ç”µè„‘æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿°åœ°å€"
        echo "   3. å¯ä»¥è®¿é—®å…±äº«ç›®å½•ä¸­çš„æ–‡ä»¶"
        echo "   4. æ–‡ä»¶ç®¡ç†å™¨æä¾›æ›´å¤šæ–‡ä»¶æ“ä½œåŠŸèƒ½"
    fi
}

# åˆ‡æ¢WebæœåŠ¡çŠ¶æ€
toggle_web() {
    local service_type=$1
    
    case $service_type in
        server)
            if pgrep -f "http.server" > /dev/null; then
                echo -e "${BLUE}æ­£åœ¨åœæ­¢WebæœåŠ¡å™¨...${NC}"
                stop_web_server
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… WebæœåŠ¡å™¨å·²åœæ­¢${NC}"
                else
                    echo -e "${RED}âŒ åœæ­¢WebæœåŠ¡å™¨å¤±è´¥${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}æ­£åœ¨å¯åŠ¨WebæœåŠ¡å™¨...${NC}"
                start_web_server
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… WebæœåŠ¡å™¨å·²å¯åŠ¨${NC}"
                    # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
                    show_info "server"
                else
                    echo -e "${RED}âŒ å¯åŠ¨WebæœåŠ¡å™¨å¤±è´¥${NC}"
                    exit 1
                fi
            fi
            ;;
        manager)
            if pgrep -f "filemanager.py" > /dev/null; then
                echo -e "${BLUE}æ­£åœ¨åœæ­¢æ–‡ä»¶ç®¡ç†å™¨...${NC}"
                stop_file_manager
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… æ–‡ä»¶ç®¡ç†å™¨å·²åœæ­¢${NC}"
                else
                    echo -e "${RED}âŒ åœæ­¢æ–‡ä»¶ç®¡ç†å™¨å¤±è´¥${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}æ­£åœ¨å¯åŠ¨æ–‡ä»¶ç®¡ç†å™¨...${NC}"
                start_file_manager $2
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… æ–‡ä»¶ç®¡ç†å™¨å·²å¯åŠ¨${NC}"
                    # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
                    show_info "manager"
                else
                    echo -e "${RED}âŒ å¯åŠ¨æ–‡ä»¶ç®¡ç†å™¨å¤±è´¥${NC}"
                    exit 1
                fi
            fi
            ;;
        gui)
            if pgrep -f "app.py" > /dev/null; then
                echo -e "${BLUE}æ­£åœ¨åœæ­¢Web GUI...${NC}"
                stop_web_gui
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… Web GUIå·²åœæ­¢${NC}"
                else
                    echo -e "${RED}âŒ åœæ­¢Web GUIå¤±è´¥${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}æ­£åœ¨å¯åŠ¨Web GUI...${NC}"
                start_web_gui
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}âœ… Web GUIå·²å¯åŠ¨${NC}"
                    # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
                    show_info "gui"
                else
                    echo -e "${RED}âŒ å¯åŠ¨Web GUIå¤±è´¥${NC}"
                    exit 1
                fi
            fi
            ;;
        *)
            echo -e "${RED}æœªçŸ¥æœåŠ¡ç±»å‹: $service_type${NC}"
            show_help
            exit 1
            ;;
    esac
}

# ä¸»ç¨‹åºé€»è¾‘
main() {
    local command=""
    local service_type="server"
    local background=false
    local port=""
    local directory=""
    local with_guide=false
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            start)
                command="start"
                shift
                ;;
            stop)
                command="stop"
                shift
                ;;
            status)
                command="status"
                shift
                ;;
            info)
                command="info"
                shift
                ;;
            -t|--type)
                service_type="$2"
                shift 2
                ;;
            -d|--dir)
                directory="$2"
                shift 2
                ;;
            -p|--port)
                port="$2"
                shift 2
                ;;
            -b|--background)
                background=true
                shift
                ;;
            -g|--with-guide)
                with_guide=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # æ‰§è¡Œç›¸åº”å‘½ä»¤
    case $command in
        start)
            start_web $service_type $background $port $directory
            if [ "$background" != "true" ]; then
                show_info $with_guide $port
            fi
            ;;
        stop)
            stop_web $service_type
            ;;
        status)
            status_web $service_type
            ;;
        info)
            show_info $with_guide $port
            ;;
        *)
            echo -e "${RED}è¯·æŒ‡å®šæœ‰æ•ˆå‘½ä»¤${NC}"
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"