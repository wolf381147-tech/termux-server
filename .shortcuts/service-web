#!/bin/bash

# 统一Web服务管理器
# 支持Web服务器、文件管理器、Web GUI等功能

# 默认配置
WEB_PORT=8000
WEB_DIR="/data/data/com.termux/files/home/storage/shared/termux-projects"
WEB_USER=$(whoami)

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 显示帮助信息
show_help() {
    echo "用法: service-web [选项] <命令>"
    echo ""
    echo "命令:"
    echo "  start     启动Web服务"
    echo "  stop      停止Web服务"
    echo "  toggle    切换Web服务状态"
    echo "  status    查看Web服务状态"
    echo "  info      显示连接信息"
    echo ""
    echo "选项:"
    echo "  -t, --type TYPE         服务类型 (server|manager|gui)"
    echo "  -d, --dir DIRECTORY     Web目录"
    echo "  -p, --port PORT         端口号"
    echo "  -b, --background        后台运行"
    echo "  -g, --with-guide        显示使用指南"
    echo "  -h, --help              显示此帮助信息"
    echo ""
    echo "示例:"
    echo "  service-web start --type server"
    echo "  service-web start --type manager --background"
    echo "  service-web stop --type server"
    echo "  service-web toggle --type server"
    echo "  service-web info"
}

# 获取本地IP地址
get_local_ip() {
    local ip=""
    
    # 方法1: 使用ip命令（如果可用）
    if command -v ip >/dev/null 2>&1; then
        ip=$(ip addr show wlan0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    fi
    
    # 方法2: 使用ifconfig命令（如果可用）
    if [ -z "$ip" ] && command -v ifconfig >/dev/null 2>&1; then
        ip=$(ifconfig wlan0 2>/dev/null | grep -E "inet[^6]" | awk '{print $2}')
    fi
    
    # 方法3: 使用netcfg命令（Android特定）
    if [ -z "$ip" ] && command -v netcfg >/dev/null 2>&1; then
        ip=$(netcfg 2>/dev/null | grep wlan0 | grep -E "UP|RUNNING" | awk '{print $3}' | cut -d'/' -f1)
    fi
    
    # 方法4: 使用ip route命令获取默认路由接口IP
    if [ -z "$ip" ] && command -v ip >/dev/null 2>&1; then
        ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1); exit}')
    fi
    
    # 方法5: 使用hostname命令
    if [ -z "$ip" ] && command -v hostname >/dev/null 2>&1; then
        ip=$(hostname -I 2>/dev/null | awk '{print $1}')
    fi
    
    # 如果所有方法都失败，尝试读取系统文件
    if [ -z "$ip" ]; then
        # 尝试读取系统网络接口信息
        if [ -f "/sys/class/net/wlan0/operstate" ] && [ "$(cat /sys/class/net/wlan0/operstate 2>/dev/null)" = "up" ]; then
            if [ -f "/sys/class/net/wlan0/address" ]; then
                ip=$(cat /sys/class/net/wlan0/address 2>/dev/null)
            fi
        fi
    fi
    
    echo "$ip"
}

# 获取公共IP地址
get_public_ip() {
    curl -s https://api.ipify.org 2>/dev/null || echo "无法获取公共IP"
}

# 启动Web服务
start_web() {
    local service_type=$1
    local background=$2
    local port=$3
    local directory=$4
    
    # 设置默认值
    if [ -z "$port" ]; then
        port=$WEB_PORT
    fi
    
    if [ -z "$directory" ]; then
        directory=$WEB_DIR
    fi
    
    echo -e "${BLUE}启动Web服务 ($service_type)...${NC}"
    
    case $service_type in
        server)
            # 启动Python Web服务器
            if [ "$background" = "true" ]; then
                cd "$directory" && python -m http.server $port > /dev/null 2>&1 &
                echo -e "${GREEN}Web服务器已在后台启动${NC}"
            else
                echo -e "${YELLOW}在目录 $directory 启动Web服务器，端口 $port${NC}"
                cd "$directory" && python -m http.server $port
            fi
            ;;
        manager)
            # 启动Web文件管理器
            if [ "$background" = "true" ]; then
                # 杀死可能存在的旧进程
                pkill -f "web-file-manager.py" 2>/dev/null
                
                # 启动Web文件管理器，并保持运行
                while true; do
                    python /data/data/com.termux/files/home/web-file-manager.py > /dev/null 2>&1 &
                    echo -e "${GREEN}Web文件管理器已在后台启动${NC}"
                    break
                done
            else
                python /data/data/com.termux/files/home/web-file-manager.py
            fi
            ;;
        gui)
            # 启动Web GUI
            echo -e "${YELLOW}启动Web GUI...${NC}"
            python /data/data/com.termux/files/home/web-gui/app.py
            ;;
        *)
            echo -e "${RED}未知服务类型: $service_type${NC}"
            return 1
            ;;
    esac
}

# 停止Web服务
stop_web() {
    local service_type=$1
    
    echo -e "${BLUE}停止Web服务 ($service_type)...${NC}"
    
    case $service_type in
        server)
            pkill -f "http.server" 2>/dev/null
            echo -e "${GREEN}Web服务器已停止${NC}"
            ;;
        manager)
            pkill -f "web-file-manager.py" 2>/dev/null
            echo -e "${GREEN}Web文件管理器已停止${NC}"
            ;;
        gui)
            pkill -f "web-gui/app.py" 2>/dev/null
            echo -e "${GREEN}Web GUI已停止${NC}"
            ;;
        *)
            echo -e "${RED}未知服务类型: $service_type${NC}"
            return 1
            ;;
    esac
}

# 查看Web服务状态
status_web() {
    local service_type=$1
    
    case $service_type in
        server)
            if pgrep -f "http.server" > /dev/null; then
                echo -e "${GREEN}Web服务器正在运行${NC}"
            else
                echo -e "${RED}Web服务器未运行${NC}"
            fi
            ;;
        manager)
            if pgrep -f "web-file-manager.py" > /dev/null; then
                echo -e "${GREEN}Web文件管理器正在运行${NC}"
            else
                echo -e "${RED}Web文件管理器未运行${NC}"
            fi
            ;;
        gui)
            if pgrep -f "web-gui/app.py" > /dev/null; then
                echo -e "${GREEN}Web GUI正在运行${NC}"
            else
                echo -e "${RED}Web GUI未运行${NC}"
            fi
            ;;
        *)
            echo -e "${RED}未知服务类型: $service_type${NC}"
            return 1
            ;;
    esac
}

# 显示连接信息
show_info() {
    local with_guide=$1
    local port=$2
    
    # 设置默认端口
    if [ -z "$port" ]; then
        port=$WEB_PORT
    fi
    
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    if [ -z "$local_ip" ]; then
        local_ip="无法获取本地IP，请检查WiFi连接"
    fi
    
    echo "=========================================="
    echo "           🌐 Web服务连接信息"
    echo "=========================================="
    echo "📱 本地IP: $local_ip"
    echo "🌐 公共IP: $public_ip"
    echo "🔌 端口: $port"
    echo "📂 目录: $WEB_DIR"
    echo "=========================================="
    echo "💻 访问地址:"
    echo "   http://$local_ip:$port"
    echo "=========================================="
    
    if [ "$with_guide" = "true" ]; then
        echo ""
        echo "💡 使用指南:"
        echo "   1. 确保手机和电脑在同一WiFi网络"
        echo "   2. 在电脑浏览器中打开上述地址"
        echo "   3. 可以访问共享目录中的文件"
        echo "   4. 文件管理器提供更多文件操作功能"
    fi
}

# 切换Web服务状态
toggle_web() {
    local service_type=$1
    
    case $service_type in
        server)
            if pgrep -f "http.server" > /dev/null; then
                echo -e "${BLUE}正在停止Web服务器...${NC}"
                stop_web_server
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ Web服务器已停止${NC}"
                else
                    echo -e "${RED}❌ 停止Web服务器失败${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}正在启动Web服务器...${NC}"
                start_web_server
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ Web服务器已启动${NC}"
                    # 显示连接信息
                    show_info "server"
                else
                    echo -e "${RED}❌ 启动Web服务器失败${NC}"
                    exit 1
                fi
            fi
            ;;
        manager)
            if pgrep -f "filemanager.py" > /dev/null; then
                echo -e "${BLUE}正在停止文件管理器...${NC}"
                stop_file_manager
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ 文件管理器已停止${NC}"
                else
                    echo -e "${RED}❌ 停止文件管理器失败${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}正在启动文件管理器...${NC}"
                start_file_manager $2
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ 文件管理器已启动${NC}"
                    # 显示连接信息
                    show_info "manager"
                else
                    echo -e "${RED}❌ 启动文件管理器失败${NC}"
                    exit 1
                fi
            fi
            ;;
        gui)
            if pgrep -f "app.py" > /dev/null; then
                echo -e "${BLUE}正在停止Web GUI...${NC}"
                stop_web_gui
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ Web GUI已停止${NC}"
                else
                    echo -e "${RED}❌ 停止Web GUI失败${NC}"
                    exit 1
                fi
            else
                echo -e "${BLUE}正在启动Web GUI...${NC}"
                start_web_gui
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✅ Web GUI已启动${NC}"
                    # 显示连接信息
                    show_info "gui"
                else
                    echo -e "${RED}❌ 启动Web GUI失败${NC}"
                    exit 1
                fi
            fi
            ;;
        *)
            echo -e "${RED}未知服务类型: $service_type${NC}"
            show_help
            exit 1
            ;;
    esac
}

# 主程序逻辑
main() {
    local command=""
    local service_type="server"
    local background=false
    local port=""
    local directory=""
    local with_guide=false
    
    # 解析命令行参数
    while [[ $# -gt 0 ]]; do
        case $1 in
            start)
                command="start"
                shift
                ;;
            stop)
                command="stop"
                shift
                ;;
            status)
                command="status"
                shift
                ;;
            info)
                command="info"
                shift
                ;;
            -t|--type)
                service_type="$2"
                shift 2
                ;;
            -d|--dir)
                directory="$2"
                shift 2
                ;;
            -p|--port)
                port="$2"
                shift 2
                ;;
            -b|--background)
                background=true
                shift
                ;;
            -g|--with-guide)
                with_guide=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}未知参数: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # 执行相应命令
    case $command in
        start)
            start_web $service_type $background $port $directory
            if [ "$background" != "true" ]; then
                show_info $with_guide $port
            fi
            ;;
        stop)
            stop_web $service_type
            ;;
        status)
            status_web $service_type
            ;;
        info)
            show_info $with_guide $port
            ;;
        *)
            echo -e "${RED}请指定有效命令${NC}"
            show_help
            exit 1
            ;;
    esac
}

# 执行主程序
main "$@"